{
   "$id":"https://data.trezor.io/message-system/schema.json",
   "$schema":"http://json-schema.org/draft-07/schema#",
   "title":"Message system",
   "description":"JSON schema of the Trezor Suite messaging system",
   "type":"object",
   "required":[
      "version",
      "timestamp",
      "sequence",
      "actions"
   ],
   "properties":{
      "version":{
         "description":"Version of the messaging system. In case we would change the format of the config itself.",
         "type":"integer",
         "minimum":1,
         "default":1
      },
      "timestamp":{
         "description":"Publish date of the config in ISO 8601 date-time format.",
         "type": "string",
         "examples":[
           "2021-03-03T03:48:16+00:00",
           "2021-03-03T03:48:16Z"
         ]
      },
      "sequence":{
         "description":"An increasing counter. Suite MUST decline any file with lower than latest number. This is to protect against replay attacks, where attacker could send an older version of the file and Suite would accept it",
         "type":"integer",
         "minimum":1,
         "default":1
      },
      "actions":{
         "description":"An array of messages which are displayed on specific conditions",
         "type":"array",
         "uniqueItems":true,
         "items":{
            "title": "Action",
            "type":"object",
            "required":[
               "if",
               "then"
            ],
            "properties":{
               "if":{
                  "title":"If",
                  "description":"An array of required conditions to show the message.",
                  "type":"array",
                  "uniqueItems":true,
                  "items":{
                     "type":"object",
                     "required":[
                        "enabled",
                        "os",
                        "environment",
                        "browser",
                        "transport",
                        "device"
                     ],
                     "properties":{
                        "enabled":{
                           "title": "EnabledServices",
                           "description":"Services active",
                           "type":"array",
                           "uniqueItems": true,
                           "items":{
                              "type":"string",
                              "enum": ["tor"]
                           },
                           "examples":[
                              "tor"
                           ]
                        },
                        "os":{
                           "title":"Operating System",
                           "description":"Eligible versions of operating systems",
                           "type":"object",
                           "required":[
                              "macos",
                              "linux",
                              "windows",
                              "android",
                              "ios"
                           ],
                           "properties":{
                              "macos":{
                                 "$ref":"#/definitions/version"
                              },
                              "linux":{
                                 "$ref":"#/definitions/version"
                              },
                              "windows":{
                                 "$ref":"#/definitions/version"
                              },
                              "android":{
                                 "$ref":"#/definitions/version"
                              },
                              "ios":{
                                 "$ref":"#/definitions/version"
                              }
                           },
                           "additionalProperties": {
                              "$ref":"#/definitions/version"
                           }
                        },
                        "environment":{
                           "title":"Environment",
                           "description":"Eligible versions of app releases",
                           "type":"object",
                           "required":[
                              "desktop",
                              "mobile",
                              "web"
                           ],
                           "properties":{
                              "desktop":{
                                 "$ref":"#/definitions/version"
                              },
                              "mobile":{
                                 "$ref":"#/definitions/version"
                              },
                              "web":{
                                 "$ref":"#/definitions/version"
                              }
                           },
                           "additionalProperties":false
                        },
                        "browser":{
                           "title":"Browser",
                           "description":"Eligible versions of browsers",
                           "type":"object",
                           "required":[
                              "firefox",
                              "chrome",
                              "chromium"
                           ],
                           "properties":{
                              "firefox":{
                                 "$ref":"#/definitions/version"
                              },
                              "chrome":{
                                 "$ref":"#/definitions/version"
                              },
                              "chromium": {
                                 "$ref":"#/definitions/version"
                              }
                           },
                           "additionalProperties": {
                              "$ref":"#/definitions/version"
                           }
                        },
                        "transport":{
                           "title":"Transport",
                           "description":"Eligible versions of transport layer apps",
                           "type":"object",
                           "required":[
                              "bridge"
                           ],
                           "properties":{
                              "bridge":{
                                 "$ref":"#/definitions/version"
                              }
                           },
                           "additionalProperties":false
                        },
                        "device":{
                           "description":"Eligible device models",
                           "type":"array",
                           "uniqueItems":true,
                           "items":{
                              "title":"Device",
                              "type":"object",
                              "required":[
                                 "model",
                                 "firmware",
                                 "vendor"
                              ],
                              "properties":{
                                 "model":{
                                    "title":"Model",
                                    "type":"string",
                                    "enum":[
                                       "t",
                                       "1"
                                    ]
                                 },
                                 "firmware":{
                                    "$ref":"#/definitions/version"
                                 },
                                 "vendor":{
                                    "title":"Vendor",
                                    "description":"Eligible authorized vendors",
                                    "type":"string",
                                    "enum":[
                                       "SatoshiLabs"
                                    ]
                                 }
                              },
                              "additionalProperties":false
                           }
                        }
                     },
                     "additionalProperties":false
                  }
               },
               "then":{
                  "title":"Then",
                  "type":"object",
                  "description":"A specific message configuration",
                  "required":[
                     "active",
                     "notification"
                  ],
                  "properties":{
                     "active":{
                        "description":"A message is active and can be shown to users satisfying rules",
                        "type":"boolean"
                     },
                     "notification":{
                        "title":"Notification",
                        "type":"object",
                        "required":[
                           "dismissible",
                           "location",
                           "message",
                           "severity"
                        ],
                        "properties":{
                           "dismissible":{
                              "description":"A user can close the message and never see it again",
                              "type":"boolean"
                           },
                           "location":{
                              "description":"The location to which the message applies. Wildcards allowed.",
                              "oneOf":[
                                 {
                                    "type":"string"
                                 },
                                 {
                                    "type":"array",
                                    "items":{
                                       "type":"string"
                                    }
                                 }
                              ]
                           },
                           "message":{
                              "title":"Message",
                              "description":"A multilingual message localization",
                              "type":"object",
                              "required":[
                                 "en-GB"
                              ],
                              "properties":{
                                 "en-GB":{
                                    "type": "string"
                                 }
                              },
                              "additionalProperties":{
                                 "type": "string"
                              }
                           },
                           "severity":{
                              "title":"Severity",
                              "type":"string",
                              "enum":[
                                 "low",
                                 "medium",
                                 "high"
                              ]
                           }
                        }
                     }
                  },
                  "additionalProperties":false
               }
            },
            "additionalProperties":false
         }
      }
   },
   "additionalProperties":false,
   "definitions":{
      "version":{
         "examples":[
            "<=20.01",
            ">30",
            "~20.1",
            "^20.1",
            "82",
            "*",
            null,
            [
               "<70",
               ">71"
            ]
         ],
         "oneOf":[
            {
               "type":"string"
            },
            {
               "type":"array",
               "uniqueItems":true,
               "items":{
                  "type":"string"
               }
            },
            {
               "type":"null"
            }
         ]
      },
      "messageLocal":{
         "type":"string"
      }
   }
}
